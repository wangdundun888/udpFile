# udp文件传输系统

### 1.概述
&emsp;本系统基于udp协议传输,分为服务端和客户端两部分,服务端主要负责响应客户端上传和下载要求,客户端主要负责向服务端发送上传或下载文件要求.

### 2.服务端和客户端模块概要设计
#### 2.1 接收模块
&emsp;负责所有消息的接收、预处理,然后把消息转发到相关模块.
#### 2.2 发送模块
&emsp;负责将其他模块传来的消息发送到指定端.
#### 2.3 上传模块
&emsp;对于客户端,负责读取文件,处理文件,然后交由发送模块上传;对于服务端,负责接收上传消息,响应消息,并在文件接收完整之后持久化文件.
#### 2.4 下载模块
&emsp;对于客户端,负责接收服务端的消息,组合文件并持久化;对于服务端,收到下载请求后,读取文件,处理文件,并发送至客户端.
#### 2.5 主模块
&emsp;初始化各种资源,负责协调各模块间的工作.
### 3.服务端模块详细设计
#### 3.1 接收模块
&emsp;开启该模块所需参数:  
&emsp;&emsp;(1) udp链接,从该链接读取udp报文,并根据报文类型,分发到上传模块或下载模块;  
&emsp;&emsp;(2) 上传通道,通过该通道,与上传模块通信,将上传消息转发到上传模块;  
&emsp;&emsp;(3) 下载通道,通过该通道,与下载通道通信,将下载消息转发到下载模块;   
&emsp;&emsp;(4) context上下文,全局管理goroutine;  
&emsp;使用udp链接读取udp报文,根据消息格式对报文分类,转发到上传或者下载模块.
#### 3.2 发送模块
&emsp;开启该模块所需参数:  
&emsp;&emsp;(1) udp链接,将需要发送的报文通过该链接发送出去;    
&emsp;&emsp;(2) 发送通道,监听该通道,将该通道出来的消息通过(1)发送出去;    
&emsp;&emsp;(3) context上下文,全局管理goroutine;  
&emsp;将从发送通道出来的消息通过udp链接发送出去.
#### 3.3 上传模块
&emsp;开启该模块所需参数:  
&emsp;&emsp;(1) 文件路径,需要上传文件的路径;    
&emsp;&emsp;(2) 接收通道,与接收模块通信所用,从该通道接收消息;    
&emsp;&emsp;(3) 发送通道,与发送模块通信所用,从该通道发送消息;    
&emsp;&emsp;(4) context上下文,全局管理goroutine;  
&emsp;首先,开启一个清理协程,清理长时间(暂定为2分钟未上传)上传未成功的数据,清理间隔为2分钟;然后从接收通道接收消息,只处理带初始化标志和正常标志的消息;
对于带初始化标志的消息,先判断是否存在,返回相应的消息,然后生成一个唯一id,存储在map里,等待上传完成,以上工作完成后,返回一个确认初始化消息;
对于带正常标志的消息,先从消息中取出文件id,判断是否存在于map中,存在则对数据进行存储,当文件数据完整时,进行持久化存储,对于每一个存在于map中的正常标志消息,都会回复一个ack;
#### 3.4 下载模块
&emsp;开启该模块所需参数:  
&emsp;&emsp;(1) 文件路径,存储下载文件的路径;    
&emsp;&emsp;(2) 接收通道,与接收模块通信所用,从该通道接收消息;    
&emsp;&emsp;(3) 发送通道,与发送模块通信所用,从该通道发送消息;    
&emsp;&emsp;(4) context上下文,全局管理goroutine;
&emsp;首先,开启一个清理协程,清理长时间(暂定为2分钟未下载)下载未成功的数据,清理间隔为2分钟;然后从接收通道接收消息,只处理带初始化标志和下载某一分片标志的消息;
对于带初始化标志的消息,先判断文件是否存在,如果存在,则读取文件,并生成一个唯一id存在map,把这个id和文件大小放在初始化ack消息中返回,以上操作完成后,发送一次整个文件;
对于带下载文件某一分片的消息,先判断文件是否存在于map中,若存在,则返回相应分片数据;
#### 3.5 主模块
&emsp;首先从命令行读取port,存储路径等参数,然后创建udp连接,最后创建三个开启各模块所需通道;以上工作完毕后,依次开启接收,发送,上传和下载模块.
### 4.客户端模块详细设计
#### 4.1 接收模块
&emsp;开启该模块所需参数:  
&emsp;&emsp;(1) udp链接,从该链接读取udp报文,并根据报文类型,分发到上传模块或下载模块;  
&emsp;&emsp;(2) 上传通道,通过该通道,与上传模块通信,将上传消息转发到上传模块;  
&emsp;&emsp;(3) 下载通道,通过该通道,与下载通道通信,将下载消息转发到下载模块;   
&emsp;&emsp;(4) context上下文,全局管理goroutine;  
&emsp;使用udp链接读取udp报文,根据消息格式对报文分类,转发到上传或者下载模块.
#### 4.2 发送模块
&emsp;开启该模块所需参数:  
&emsp;&emsp;(1) udp链接,将需要发送的报文通过该链接发送出去;    
&emsp;&emsp;(2) 发送通道,监听该通道,将该通道出来的消息通过(1)发送出去;    
&emsp;&emsp;(3) context上下文,全局管理goroutine;  
&emsp;将从发送通道出来的消息通过udp链接发送出去.
#### 4.3 上传模块
&emsp;开启该模块所需参数:  
&emsp;&emsp;(1) 文件路径,需要上传文件的路径;    
&emsp;&emsp;(2) 文件名,需要上传文件的文件名;    
&emsp;&emsp;(3) 接收通道,与接收模块通信所用,从该通道接收消息;    
&emsp;&emsp;(4) 发送通道,与发送模块通信所用,从该通道发送消息;    
&emsp;&emsp;(5) context上下文,全局管理goroutine;  
&emsp;首先,根据参数,打开读取和处理文件;然后,将上传文件大小、文件名等参数告知服务端并等待确认回复;收到确认回复后,开始发送文件切片,等待所有确认回复后退出,如果在超时时间内,
没有收到相应文件切片的回复,则重新发送这些文件切片.  
#### 4.4 下载模块
&emsp;开启该模块所需参数:  
&emsp;&emsp;(1) 文件路径,存储下载文件的路径;    
&emsp;&emsp;(2) 文件名,需要下载文件的文件名;    
&emsp;&emsp;(3) 接收通道,与接收模块通信所用,从该通道接收消息;    
&emsp;&emsp;(4) 发送通道,与发送模块通信所用,从该通道发送消息;    
&emsp;&emsp;(5) context上下文,全局管理goroutine;  
&emsp;
#### 4.5 主模块
&emsp;首先从命令行读取ip,路径,文件名和上传开关等参数,然后创建udp连接,最后创建三个开启各模块所需通道;初始化完毕之后,开启接收和发送模块,然后根据参数开启上传或者下载模块.
### 5.客户端与服务端简单通信协议设计
第 0 个比特：  
&emsp;b7:  
&emsp;&emsp;0,对于服务端,表示客户端上传文件;对于客户端,表示服务端对上传文件的响应.  
&emsp;&emsp;1,对于服务端,表示服务端下载文件;对于客户端,表示服务端对下载文件的响应.  
&emsp;b6-b0:  
&emsp;&emsp;0,表示初始报文,此时第三个和第四个比特表示文件切割后总的长度,第五个及以后为数据区,表示文件名.  
&emsp;&emsp;1,表示服务端对客户端初始报文的确认,此时第一个和第二个比特表示一个文件id,该id在服务端生成,且唯一.  
&emsp;&emsp;2,正常上传/下载报文,此时有id和分片号.  
&emsp;&emsp;3,对上传/下载报文的确认.  
&emsp;&emsp;4,由服务端发出,告知客户端上传失败.  
&emsp;&emsp;5,由服务端发出,告知客户端上传繁忙,请稍后重试.  
&emsp;&emsp;6,由服务端发出,告知客户端文件已存在.  
&emsp;&emsp;7,由服务端发出,告知客户端文件不存在.  
&emsp;&emsp;8,由客户端发出,告知服务端,需要下载文件的某一分片.  
&emsp;&emsp;其他预留.  
第 1,2 个比特:  
&emsp;构成文件id,大端编码.  
第 3,4 个比特:
&emsp;构成文件总长度或分片号.  
第 5 个及以后比特:  
&emsp;数据区,不定长.

